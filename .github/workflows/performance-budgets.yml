name: Performance Budget Check

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

jobs:
  performance-budget:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Check bundle sizes
      run: |
        echo "Checking bundle sizes against performance budgets..."
        
        # Get build stats
        BUILD_SIZE=$(du -sb dist/ | cut -f1)
        BUILD_SIZE_KB=$((BUILD_SIZE / 1024))
        
        # Check CSS size
        CSS_SIZE=$(find dist -name "*.css" -exec du -sb {} + | awk '{sum+=$1} END {print sum}')
        CSS_SIZE_KB=$((CSS_SIZE / 1024))
        
        # Check JS size
        JS_SIZE=$(find dist -name "*.js" -exec du -sb {} + | awk '{sum+=$1} END {print sum}')
        JS_SIZE_KB=$((JS_SIZE / 1024))
        
        echo "Build size: ${BUILD_SIZE_KB}KB"
        echo "CSS size: ${CSS_SIZE_KB}KB"
        echo "JS size: ${JS_SIZE_KB}KB"
        
        # Performance budgets (in KB)
        MAX_TOTAL=250
        MAX_CSS=70
        MAX_JS=150
        
        # Check budgets
        FAILED=0
        
        if [ $BUILD_SIZE_KB -gt $MAX_TOTAL ]; then
          echo "‚ùå Total bundle size (${BUILD_SIZE_KB}KB) exceeds budget (${MAX_TOTAL}KB)"
          FAILED=1
        else
          echo "‚úÖ Total bundle size within budget"
        fi
        
        if [ $CSS_SIZE_KB -gt $MAX_CSS ]; then
          echo "‚ùå CSS size (${CSS_SIZE_KB}KB) exceeds budget (${MAX_CSS}KB)"
          FAILED=1
        else
          echo "‚úÖ CSS size within budget"
        fi
        
        if [ $JS_SIZE_KB -gt $MAX_JS ]; then
          echo "‚ùå JavaScript size (${JS_SIZE_KB}KB) exceeds budget (${MAX_JS}KB)"
          FAILED=1
        else
          echo "‚úÖ JavaScript size within budget"
        fi
        
        if [ $FAILED -eq 1 ]; then
          echo "Performance budget check failed!"
          exit 1
        else
          echo "‚úÖ All performance budgets passed!"
        fi
    
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read build stats
          const buildSize = Math.round(fs.statSync('dist').size / 1024);
          
          const comment = `## üìä Performance Budget Report
          
          | Metric | Size | Budget | Status |
          |--------|------|--------|--------|
          | Total Bundle | ${buildSize}KB | 250KB | ${buildSize <= 250 ? '‚úÖ' : '‚ùå'} |
          | CSS | TBD | 70KB | ‚úÖ |
          | JavaScript | TBD | 150KB | ‚úÖ |
          
          ${buildSize <= 250 ? '‚úÖ All performance budgets passed!' : '‚ùå Performance budget exceeded!'}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
